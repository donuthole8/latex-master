\chapter{手法}
  \section{概要}
    提案手法概要図を\fref{提案手法概要図}に示す．まず，災害後空撮画像の三次元復元を行うことによってオルソ画像（直下視点画像）とDSM（数値標高モデル）の作成を．．．．．．

    提案手法では，入力として災害後空撮画像，国土地理院DEMを利用し，土砂量図と土砂移動図を最終出力結果とする．

    \begin{figure}[t]
      \centering
      \includegraphics[width=12cm]{image/processing-flow.png}
      \caption{提案手法概要図}
      \label{提案手法概要図}
    \end{figure}


  \section{入力データ}
    \label{入力データ}
    入力データの特徴等\dots

    - 複数枚の災害後空撮画像，直下視点が望ましい，季節は植生が緑が良いかも，災害前DEMが整備されている，視差が得られるように，

    - 災害前DEM，5mメッシュが望ましい，



  \section{三次元復元}
    まず，災害後空撮画像の三次元復元を行うことによってオルソ画像（直下視点画像）とDSM（数値標高モデル）の作成を行う．三次元復元とは複数枚画像を用いて被写体の形状や距離等の3次元情報を復元する処理である．オルソ画像は，三次元復元によって得られた三次元モデルを真上から投影した状態の各画素を取得することによって得る．DSMは三次元モデルを真上から投影した状態の数値標高モデルの各標高値を取得することによって得る．本手法では復元精度の高いAgisoft社のMetashape\cite{使用手法1}を利用する．

    その後，災害後空撮画像によって得られたDSMは国土地理院DEMに比べ空撮画像の撮影範囲分のみであり領域が狭いため，災害後DSMと同範囲を抽出することによって無駄な領域を削除する．この処理によって，後述の災害後DSMの標高値の正規化処理において国土地理院のDEMの最大標高を基準とした正規化処理が可能となる．
  
    また，災害前後での標高値モデルは解像度が異なるため，最も滑らかな画素補間手法であるバイキュービック法\cite{論文手法1}を用いることによって解像度を統一する．一般的には国土地理院DEMは解像度が粗いため，この手法を用い国土地理院DEMを拡大する．

    最後に，後述の処理で色相と水平座標の距離が近い領域単位での処理を行うため，オルソ画像に対しMean-Shift法\cite{論文手法2}による領域分割を行う．また，この処理によって空撮画像の撮影機器や画像上の細かい地物による色や輝度のばらつきを抑制する．


    TODO: アラインメント？アライメント？使ってるMetashapeの名称に合わせる
    \subsection{写真のアラインメント}
      \label{写真のアラインメント}
      入力画像に対して特徴点の検出を行い，特徴マッチングを行うことで疎な点群の復元を行う．植生や水域等の特徴の少ない領域が原因でマッチングに失敗する場合があるため，失敗した画像を除去し再度処理を行う．また，精度を指定することが可能であり，精度を下げると入力画像の解像度を下げることによって処理時間を短縮する．提案手法では「高」（最大精度．．．．最高かも）を指定し，その他の項目では既定値にて処理を行う．本処理の設定値を\fref{}に，\ref{入力データ}節を用いた時の処理結果を\fref{}に示す．

    \subsection{高密度クラウド構築}
      \label{高密度クラウド構築}
      \ref{写真のアラインメント}項によって得られた点群と入力画像より法線を算出し，密な点群を生成する．精度を指定することが可能であり，後述の\ref{DEM構築}項の精度に影響する．また，深度フィルタによって外れ値の除去を行うことができる．提案手法では「高」に設定し，その他の項目では既定値にて処理を行う．本処理の設定値を\fref{}に，\ref{写真のアラインメント}項の出力結果を用いた時の処理結果を\fref{}に示す．

    \subsection{メッシュ構築}
      \label{メッシュ構築}
      \ref{高密度クラウド構築}項によって得られた点群からポリゴンメッシュの構築を行う．三次元点群から三次元モデルを復元することによって，後述の\ref{Z軸指定}項の処理が用意になる．本処理の設定値を\fref{}に，\ref{高密度クラウド構築}項の出力結果を用いた時の処理結果を\fref{}に示す．

    \subsection{テクスチャ構築}
      \label{テクスチャ構築}
      \ref{メッシュ構築}項によって生成元の点群の色が割り当てられるが，頂点の色のみが対象であるため解像度が低い．そのため，本処理によって入力画像のテクスチャを生成したメッシュに貼り付ける．本処理の設定値を\fref{}に，\ref{メッシュ構築}項の出力結果を用いた時の処理結果を\fref{}に示す．

    \subsection{Z軸指定}
      \label{Z軸指定}
      おれのは直下視点だから別話，，，

      やり方書く（変な処理だったら消して良いかも〜）
      本処理の処理結果を\fref{}に示す．




      ここまでで構築した三次元モデルが直下視となるよう，Metashape 上にて回転を行う.ヘリコプター撮影映像が鳥瞰視点であるため，正しい Z 軸を Metashape 上で推定することは困難である. したがって本研究では，手動による回転を行う.
      これにより奥行きが標高値へと変換できるため，DEMデータの構築とオルソモザイク画像の構築を行うことができる．出力結果を図2.9に示す

    \subsection{オルソモザイク構築}
      \label{オルソモザイク構築}
      \ref{テクスチャ構築}項 or \ref{Z軸指定}項によって得られた直下視点の三次元モデルを投影することよって擬似的な直下視点画像（オルソモザイク画像，以降，オルソ画像）を構築する．プロジェクション面に「現在のビュー」を指定し，オルソ画像を出力する．本処理の設定値を\fref{}に，\ref{Z軸指定}項の出力結果を用いた際の処理結果を\fref{}に示す．
      
    \subsection{DEM構築}
      \label{DEM構築}
      \ref{オルソモザイク構築}項と同様，プロジェクション面に「現在のビュー」を指定することで直下視の投影方向にてDEMデータの構築を行う．ここで，ソースデータに「高密度クラウド」を指定することで，より精度の高いDEMデータを構築することができる．一般的な測量手法では，地上基準点（GCP）やExifタグによりスケールや位置情報を埋め込むが，本研究でのヘリコプター空撮画像ではこれらが利用できないため，得られる標高値はモデル内での相対的な値となる．本処理の設定値を\fref{}に，\ref{Z軸指定}項の出力結果を用いた際の処理結果を\fref{}に示す．
      また，処理名称は「DEM構築」であるが，本研究では植生や建物の標高値を含まない標高値モデルのことをDEM（Digital Elevation...，どっかで前述してあれば良い，多分入力データでしてる），植生や建物の標高値を含む標高値モデルのことをDSM（Digital Surface Model）と呼ぶ．


  \section{災害前DEMの前処理}
    \subsection{リサンプリング}
      \ref{土砂量推定}節にて災害前後の標高値差分を取る際に，災害前後の標高値モデルの解像度が異なるためリサンプリング処理によって解像度を統一する．本研究では災害前の標高値モデルに国土地理院提供のDEM，災害後の標高値モデルは\ref{DEM構築}項にて出力したDSMを用いる．国土地理院提供のDEMのメッシュ解像度は5m，或いは10mであり，本研究で用いるDSMのメッシュ解像度は数十cm〜XXm（TODO: 調べる）であるため，災害前標高値モデルに対しバイキュービック補間\cite{論文手法1}を行い拡大することによって解像度を統一する．バイキュービック法（TODO:後で修正）は最も滑らかな画素補間法であり，以下の手順によって算出できる．
      
      注目画素の周辺の$4\times4$（16）画素に対し\Fref{バイキュービック法}を適用することによって得られる．x,yを．．．，iをっっｘとする．

      TODO: 後で良さげな式調べる
      \begin{eqnarray}
        \label{バイキュービック法1}
          d(x,y) = 
          \begin{bmatrix}
          (h(y_{1}) & h(y_{2}) & h(y_{3}) & h(y_{4}))
          \end{bmatrix}
          \begin{bmatrix}
            i(-1,-1) & i(0,-1) & i(1,-1) & i(2,-1) \\
            i(-1,0) & i(0,0) & i(1,0) & i(2,0) \\
            i(-1,1) & i(0,1) & i(1,1) & i(2,1) \\
            i(-1,2) & i(0,2) & i(1,2) & i(2,2)
          \end{bmatrix}
          \begin{bmatrix}
            h(x_{1}) & h(x_{2}) & h(x_{3}) & h(x_{4})
          \end{bmatrix}
        \end{eqnarray}
  
        \begin{eqnarray}
          \label{バイキュービック法2}
            \left\{
              \begin{array}{l}
                x_{1} = 1 + x - [x] \\
                x_{2} = x - [x]     \\
                x_{3} = [x] + 1 - x \\
                x_{4} = [x] + 2 - x \\
                y_{1} = 1 + y - [y] \\
                y_{2} = y - [y]     \\
                y_{3} = [y] + 1 - y \\
                y_{4} = [y] + 2 - y
              \end{array}
            \right.
          \end{eqnarray}

          \begin{eqnarray}
            \label{バイキュービック法3}
              h(t) = 
              \left\{
                \begin{array}{ll}
                  (a + 2) |t|^3 - (a + 3)|t|^2 + 1 & (|t| \leq 1)   \\
                  a|t|^3 - 5a|t|^2 + 8a|t| - 4a    & (1 < t \leq 2) \\
                  0                                & (2 < |t|)
                \end{array}
              \right.
            \end{eqnarray}
  
    \subsection{災害前DEMの切り抜き}
      災害前DEMは．．．
      TODO: いらないかも，実験データ切り抜いて使うなら

      災害後DSM領域の抽出も一緒に

    \subsection{傾斜度・傾斜方位の算出}
    TODO: Hornの公式かも
      XXXの指標として，\ref{土砂移動推定}節にて，．．．．．傾斜度，傾斜方位を利用する．傾斜度とは，ある画素の傾斜度を表す指標であり，傾斜度の値が大きいほど地表が急勾配であることを表す．傾斜方位とは，下りの傾斜度が指している方向を表す．各指標は\Fref{傾斜度}，\Fref{傾斜方位}によって算出される．なお，傾斜方位は0°（真北 TODO: °は記号にできるかも）から360°（真北）で右回りに計算される指標である．$\dfrac{dz}{dx}$，$\dfrac{dz}{dy}$は$3 \times 3$画素（9画素）のメッシュがあった場合に，中心画素の$X$方向と$Y$方向の変化率であり，\Fref{X方向の変化率}，\Fref{Y方向の変化率}より算出される．

      TODO: （もう1箇所，バイキュービック法も，）$x_{1.1}$とか$x_{8}$とかの表記に変える（図もつける） or 式短く小さく

      TODO: ArcTan? Atan？
      TODO: 式あっているか調べる・参考文献掲載
      \begin{equation}
        \label{傾斜度}
        slope_{radians} = 
        \dfrac{180} {\pi} \times
        atan \sqrt{
          (\dfrac{dz}{dx})^2 + (\dfrac{dz}{dy})^2
        }
      \end{equation}

      \begin{equation}
        \label{傾斜方位}
        aspect = 
        \dfrac{180} {\pi} \times
        \arctan 2 (\dfrac{dz}{dy}, \dfrac{dz}{dx})
      \end{equation}

      \begin{equation}
        \label{X方向の変化率}
        \dfrac{dz}{dx} = 
          \dfrac{
            (d(x+1,y-1) + 2d(x+1,y) + d(x+1,y+1)) - 
            (d(x-1,y-1) + 2d(x-1,y) + d(x-1,y+1))
            } 
          {8}
      \end{equation}

      \begin{equation}
        \label{Y方向の変化率}
        \dfrac{dz}{dy} = 
          \dfrac{
            (d(x-1,y+1) + 2d(x,y+1) + d(x+1,y+1)) - 
            (d(x-1,y-1) + 2d(x,y-1) + d(x+1,y-1))
            } 
          {8}
      \end{equation}

    \fref{}から\fref{}にDEMから導出した傾斜度と傾斜方向を示す．


  \section{領域データの抽出}
    本研究では，土砂領域検出及び建物領域検出の際に領域単位で処理を行うため，災害後オルソ画像より領域データを算出する．検出処理では主にピクセル単位，領域単位，メッシュ単位，．．での検出単位が存在する．ピクセル単位での検出の場合．．．XXX．よって，本研究では領域単位で検出を行う．本節では各領域の領域番号，面積，重心座標，周囲長，輪郭座標．．．を取得する．


    \subsection{オルソ画像の領域分割}
      空撮画像等の土砂領域や植生領域を画素単位で検出することは難しいため，近傍画素との関係性を考慮した領域単位での判別を行う．本研究ではMean-Shift法\cite{}を用いた領域分割を行う．Mean-Shift法はカーネル密度推定によるクラスタリング手法の一つで，画像の領域分割，動画像における対象物体追跡に用いられる．また，領域分割の代表的な手法であるk-means法\cite{}に比べ，クラスタ数を事前に決める必要が無いという利点がある．Mean-Shift法は，$d$次元空間中の$N$個の点群を標本として得られるような確率密度関数$f(x)$を考え，その標本点から確率密度関数$f(x)$の極大点を探索する手法である．次に，Mean-Shift法にてカラー画像の領域分割を行う手順について説明する．

      1. カラー画像中の各画素の位置を二次元座標$x_i$，その画素値を三次元チャンネル$v_{i} =(R_{i},G_{i},B_{i})$とし，画素位置と画素値を結合した5次元空間内の点$z_{i} = (x_{i}, v_{i})$を考える．距離と色相が近い画素が5次元空間内でクラスタを成しているとし，各画素をMean-Shift法でクラスタリングする．

      2. すべての$z_{i}$にMean-Shift法を適用し，収束位置$z_{i}^c = (x_{i}^c , v_{i}^c)$を計算する．
      
      3. $x_{i}$の画素値を収束位置の画素の値$v^c = (R^c, G^c, B^c)$に置き換えることによって領域分割ができる．カーネル密度推定とMean-Shift法の計算式を\Fref{Mean-Shift法1}と\Fref{Mean-Shift法2}示す．ただし，\Fref{Mean-Shift法3}を満たすとする.
    
      \begin{equation}
        \label{Mean-Shift法1}
        f(x) = \dfrac{c} {N h_{s}^2 h_{r}^3}
          \sum_{i=1}^{N}
          k (|\dfrac{x^s - x_{i}^s} {h_{s}}|^2) k (|\dfrac{x^r - x_{i}^r} {h_{r}}|^2)
      \end{equation}

      TODO: 2行目，最後のr，式あってるか確認
      \begin{equation}
        \label{Mean-Shift法2}
        y_{j+1}^s = 
          \dfrac{\sum_{i=1}^{N} g_{i}^s x_{i}^s} {\sum_{i=1}^{N} g_{i}^s}, 
        y_{j+1}^r = 
          \dfrac{\sum_{i=1}^{N} g_{i}^r x_{i}^r} {\sum_{i=1}^{N} g_{i}^r??}
      \end{equation}

      \begin{equation}
        \label{Mean-Shift法3}
        g_{i}^s = k' (|\dfrac{y_{j}^s - x_{i}^s} {h_{s}}|^2)
                  k  (|\dfrac{y_{i}^r - x_{i}^r} {h_{r}}|^2), 
        g_{i}^r = k  (|\dfrac{y_{j}^s - x_{i}^s} {h_{s}}|^2) 
                  k' (|\dfrac{y_{i}^r - x_{i}^r} {h_{r}}|^2)
      \end{equation}

      なお，本研究ではMean-Shift法の特徴量空間に距離を表す画素位置$(x,y)$，色相を表す画素値$(R,G,B)$を用いるため5次元空間での処理となり，距離・色相の近い画素群が一つの領域となる．領域分割の適用例を\fref{}に示す．

      また，この際に各領域の座標データをコンピュータ上に保存する．．．（良い書き方ねえか？？）ファイル，テキストファイル，バイナリファイル，イメージデータとして

    \subsection{領域データの算出}
    \subsection{or カラーラベリング}
      通常のラベリング処理では，類似色の領域が潰れてしまうという欠点がある．
      \ref{オルソ画像の領域分割}項にて取得した座標データを利用し，ラベリングテーブルを作成する．作成したラベリングテーブルより，領域番号毎に輪郭抽出を行う．．．
      領域毎に以下の処理を行う．
        1. 領域の全座標を取得
        2. 領域座標よりを用いてその領域の輪郭抽出を行う
        3. 輪郭データより面積・周囲長頭を算出
        4. ラベリングテーブルに保存．．．みたいな？
      


  \section{災害後DSMの前処理}
    DSMは建物・樹木等を含む標高値モデルに対し，DEMは建物・樹木等の地表物の高さを含まないため，単純に災害前後の標高値差分を取った場合にずれが生じる．よって，ここでは災害後DSMの建物領域に対し標高値補正を行う．植生領域については，\ref{植生除去}項にて除去を行う．

    \subsection{ジオリファレンサ}
    TODO: オルソ・DEM項に追記必要かも？，位置情報
      \ref{入力データ}節で用いる空撮画像において，位置情報が埋め込まれていない画像群の例が存在する．この場合，\ref{オルソモザイク構築}項，\ref{DEM構築}項で前述したようにオルソ画像や災害後DSMは位置情報を持たない．しかし，後述の処理でオルソ画像や災害後DSMと，国土地理院DEM等の位置情報が対応付けられいてる必要がある．そのため，災害後DSMに位置情報が付与されていない場合，オープンソースの地理情報システム（GIS:Geographic Information System）であるQGIS\cite{QGIS}のジオリファレンサ機能を利用して位置合わせを行う．ジオリファレンサとは，位置情報を持たないラスタデータに任意の位置情報を付与する手法であり，この処理によって位置情報を持たないオルソ画像や災害後DSMを地図上に重畳できる．
      
      QGISにてジオリファレンサを起動し，ラスタデータと地図上のランドマークの対応点付けを行う．ラスタデータのランドマークを選択し，地図上の同一のランドマークを選択する．最低4箇所の対応付けが必要であり，ラスタデータと地図上の対応するランドマークの対応付け箇所が多いほど精度が向上する．本処理の設定値を\fref{}に，\ref{DSM構築}項の出力結果を国土地理院の標準地図\cite{標準地図}上に重畳した結果を\fref{}に示す．

    \subsection{建物領域の検出}
      \label{建物領域の検出}
      TODO: 凸領域で検出したかった
      建物領域は直下視点の空撮画像中では単純な形状であることが多い．そのため，\ref{オルソモザイク構築}節で得たオルソ画像の各領域に対し円形度による閾値処理を行うことによって，建物候補領域を抽出する．円形度は領域形状の簡易さを表す指標であり，\Fref{円形度}で表される．$S$は領域の面積，$L$は領域の周囲長，$C$は円形度を示す．

      \begin{equation}
        \label{円形度}
        C = \dfrac{4 \pi S} {L^2} 
      \end{equation}

      その後，テクスチャ特徴による分類を行うことによって建物領域を抽出する．建物領域の屋根部分は均一であるという特徴を持つため，ある領域内の画素の不均一性を示す指標である異質度（dissimilarity）\cite{論文手法3}を導入する．異質度\Fref{異質度}による閾値処理を行うことによって，建物領域を抽出する．$P(i,j)$は$(i,j)$における画素値，$dissimilarity$は異質度を示す．

      TODO: もう少し詳細に
      \begin{equation}
        \label{異質度}
        dissimilarity = \sum_{i=0}^{255} \sum_{j=0}^{255} (i,j) |i-j|
      \end{equation}

      TODO: QGISでの処理も書くかも
      また，国土地理院の提供する建築物ポリゴンデータ\cite{}を利用することによって，建物候補領域から建物領域を検出する．建物候補領域の検出結果に建築物ポリゴンデータを重畳し，建物候補領域に建築物ポリゴンデータのピクセルが50\%以上含まれる場合，その建物候補領域を建物領域として検出する．

    \subsection{建物領域の標高値補正}
      その後，抽出した建物領域に隣接する地表面領域の標高値を用いて建物領域の全画素の標高値を地表面領域の平均標高値に変換することで，建物領域の標高値を除去する．

    \subsection{災害後DSMの正規化}
      次に，\ref{DEM構築}によって得られたDSMはモデル内での相対的な標高値であるため，国土地理院DEMと水平位置を対応付けし，\Fref{正規化}を適用することによって正規化した絶対的な標高値を与える．$x$は正規化前のDSMの標高値，$x'$は正規化後のDSMの標高値を示す．

      \begin{equation}
        \label{正規化}
        x'_{i} = \dfrac{x_{i} - min(x)} {max(x) - min(x)} \times max(DEM) 
      \end{equation}


  \section{土砂領域のマスク画像作成}
    \label{土砂マスク}
    \subsection{L*a*b*表色系変換}
      空撮画像中の土砂領域は




      斜面崩壊・浸水領域での色相や輝度などの特徴を表2.1に示す．これらの特徴を用いて各領域の検出を行う．x〜x項に本手法で用いる指標の算出方法と各災害領域について示す．

      オルソ画像中の土砂領域・植生領域はそれぞれ赤色味・緑色味が強くなる傾向がある．本研究では人間の色覚に類似したL*a*b*表色系を用い，赤色味の強い画素では$a*$値が高く，緑色味の強い画素では $a*$値が低いという特徴を利用した閾値処理によって土砂候補領域・植生領域の検出を行う．
      
      検出した土砂候補領域より植生領域を除去し，土砂領域として残った領域を二値化することによって土砂マスクを生成する．


      \tref{}の特徴に従って分類を行うためヒストグラム均一化を行った画像に対しL*a*b*変換[8]を行う．L*a*b*色空間とは輝度を$L*$，色相と彩度を示す色度を$a*,b*$で表した色空間である．また，人間の視覚に近い色空間であるため，色情報を用いて分類を行う際に有効な指標である．本研究で用いる画像は現時点ではRGB色空間にて表されているためL*a*b*色空間への変換を行う．RGB色空間からL*a*b*色空間への変換式を\Fref{Lab表色系1}と\Fref{Lab表色系2}に示す．RGB色空間はデバイス依存色であり直接L*a*b*色空間に変換する式は存在しないため，デバイス独立色であるXYZ色空間[8]に変換してから処理を行う．XYZ色空間への変換は$0$から$255$までの8bit値を$0$から$1$に正規化し，$γ=2.2$に対するガンマ補正を線形の測定値に戻す．$E$は$R,G,B$のいずれかを表し，ダッシュ付きはガンマ補正された値を示す．ただし，\Fref{Lab表色系4}を満たすとする．

      TODO: a*,b*の括弧が一つ多い
      \begin{eqnarray}
      \label{Lab表色系1}
        \left\{
          \begin{array}{l}
            L* = 116 \times f(\dfrac{Y} {Y_{n}}) - 16 \\
            a* = 500 \times [f(\dfrac{X} {X_{n}}) - f(\dfrac{Y} {Y_{n}})] \\
            b* = 200 \times [f(\dfrac{Y} {Y_{n}}) - f(\dfrac{Z} {Z_{n}})]
          \end{array}
        \right.
      \end{eqnarray}

      \begin{eqnarray}
        \label{Lab表色系2}
        \left\{
          \begin{array}{l}
            X = 0.412453R + 0.357580G + 0.180423B \\
            Y = 0.212671R + 0.715160G + 0.072169B \\
            Z = 0.019334R + 0.119193G + 0.950227B
          \end{array}
        \right.
      \end{eqnarray}

      \begin{eqnarray}
        \label{Lab表色系4}
          f(t) = 
          \left\{
            \begin{array}{lll}
              \sqrt[3]{t} 
                &(t >    (\dfrac{6} {29})^3) \\
              \dfrac{1} {3} (\dfrac{29} {6})^3 t + \dfrac{4} {29}
                &(t \leq (\dfrac{6} {29})^3)
            \end{array}
          \right.
      \end{eqnarray}

    \subsection{土砂候補領域検出}
      斜面崩壊領域は\tref{}に示すように，輝度と色相，彩度に特徴を持つ．よって，これらの特徴を表すL*a*b*色空間のL*値とa*値，HSV色空間のS値を用いる．ヒストグラム均一化処理後の画像に対しL*a*b*変換とHSV変換を行い，これらの指標を用いた閾値処理により斜面崩壊領域を検出する．

    \subsection{植生領域検出}
      \label{植生除去}
      各不要領域の特徴を\Fref{}に示す．...節と同様にこれらの特徴を用いて各領域の検出を行う．...項に各不要領域について示す．
      斜面崩壊は植生を多く含む山間部の斜面にて発生し，土砂に混ざった植生部分を誤検出する可能性がある．（あと普通に繁茂してるやつ）よって，\Fref{}で示した植生領域の特徴から，a*値を用いた閾値処理によって植生領域を検出する．

    \subsection{統合処理による土砂領域検出}
    \subsection{土砂領域検出結果の二値化処理}
    \subsection{土砂領域のマスク画像作成}

  
  \section{土砂量推定}
    \label{土砂量推定}
    災害後の空撮画像より作成した標高値補正済みDSMと災害前の解像度補正済み国土地理院DEMの被災前後での標高値差分を求めることにより，災害前後での土砂量変化を算出する．また，\ref{土砂マスク}節で作成した土砂マスクの領域に限定して処理を行うことにより，植生領域のずれや誤検出を除去する．
  

  \section{土砂移動推定}
    \label{土砂移動推定}
      TODO: 開閉地形等を基準の中心点とできないか

    精度評価の際にMean-Shift法での領域ベースでの正解データの目視判読による作成は領域数の多さに起因し困難であるため，メッシュベースでの土砂移動推定を行う．今回は地表面での土砂移動が確認できたランドマークの最大移動距離に合わせ，オルソ画像を縦13メッシュ，横12メッシュに区切った．

    土砂移動は一般的に上流から下流へ流下する．また，一般的に災害後には上流領域は土砂崩壊部で侵食が発生し，下流領域には上流より流下した土砂が堆積する．よって，メッシュ中心画素から以下の4条件を満たす画素を全て追跡し，メッシュ中心画素から最も距離の遠い画素へ移動線を結ぶことによって土砂移動が発生したと推定する．

    ・	上流方向から下流方向に沿って傾斜方向が向いている

    ・	上流画素の標高値が下流画素の標高値より低い
    
    ・	画素同士が隣接している
    
    ・	侵食領域と堆積領域の組み合わせである

    傾斜方向の判別には災害後DSMより作成した傾斜方向モデルを用い，侵食領域と堆積領域の組み合わせの判別には\ref{土砂量推定}節の土砂量推定結果を用いる．
  

